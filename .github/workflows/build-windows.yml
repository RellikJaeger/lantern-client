name: Build Windows

on:
  workflow_call:
    inputs:
      version:
        type: string
        required: true
      prefix:
        type: string
        required: true
      build-suffix: # "64" or ""
        type: string
        required: false
      dist-suffix: # "64-bit" or "32-bit"
        type: string
        required: true
      update-suffix: # "x64" or "386"
        type: string
        required: true
      installer-suffix: # "-x64" or ""
        type: string
        required: false

env:
  GOPRIVATE: github.com/getlantern
  S3_BUCKET: lantern
jobs:
    build-desktop:
      permissions:
        contents: "read"
        id-token: "write"
      env:
        version: ${{ inputs.version }}
        prefix: ${{ inputs.prefix }}
      runs-on: ubuntu-20.04
      steps:
      - uses: actions/checkout@v3
        with:
          lfs: true

      - name: Pull LFS objects
        run: git lfs pull

      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.21

      - name: Granting private modules access
        run: |
          git config --global url."https://${{ secrets.GH_TOKEN }}:x-oauth-basic@github.com/".insteadOf "https://github.com/"

      - name: Repo access
        run: |
          mkdir /tmp/cache
          echo "machine github.com login ${{ secrets.GH_TOKEN }} password x-oauth-basic" > /tmp/cache/.netrc
          chmod 600 /tmp/cache/.netrc

      - name: Setup Sentry CLI
        uses: mathieu-bour/setup-sentry-cli@v1
        with:
          version: latest
          token: ${{ SECRETS.SENTRY_TOKEN }} # from GitHub secrets
          organization: getlantern
          project: android

      - name: Install dependencies
        run: |
          sudo apt-get install -y file build-essential pkg-config
          sudo apt-get install -y mingw-w64 nsis    

      - name: Build liblantern.dylib
        if: ${{inputs.update-suffix}} == '386'
        run: |
          CGO_ENABLED=1 CC=i686-w64-mingw32-gcc CXX=i686-w64-mingw32-g++ GOOS=windows GOARCH=386 go build -buildmode=c-shared -o desktop/liblantern.dylib desktop/lib.go

      - name: Build liblantern.dylib
        if: ${{inputs.update-suffix}} == 'x64'
        run: |
          CGO_ENABLED=1 CC=x86_64-w64-mingw32-gcc CXX=x86_64-w64-mingw32-g++ GOOS=windows GOARCH=amd64 go build -buildmode=c-shared -o desktop/liblantern.dylib desktop/lib.go

      - uses: actions/upload-artifact@v3
        with:
          name: libgo-windows-${{inputs.update-suffix}}-build
          if-no-files-found: error
          path: |
            desktop/liblantern.dylib

    build-windows:
      needs: build-desktop
      permissions:
        contents: "read"
        id-token: "write"
      env:
        version: ${{ inputs.version }}
        prefix: ${{ inputs.prefix }}
      runs-on: windows-latest
      steps:
        - uses: actions/checkout@v3
          with:
            lfs: true

        # Install Flutter
        - uses: subosito/flutter-action@v2
          with:
            channel: "stable"

        - run: flutter --version

        - name: Setup protoc
          uses: arduino/setup-protoc@v2
          with:
            repo-token: ${{ secrets.GITHUB_TOKEN }}

        - name: Activate protoc-gen-dart plugin
          run: |
            dart pub global activate protoc_plugin

        - name: Download the win build output
          uses: actions/download-artifact@v3
          with:
            name: libgo-windows-${{inputs.update-suffix}}-build

        - name: Build Flutter app
          run: flutter build windows

        - name: Rename file
          run: mv build/windows/x64/runner/Release/androidlantern.exe lantern-installer${{inputs.installer-suffix}}.exe

        - uses: actions/upload-artifact@v3
          with:
            if-no-files-found: error
            name: windows${{inputs.build-suffix}}-installer-unsigned
            path: lantern-installer${{inputs.installer-suffix}}.exe

    upload-windows:
      needs: build-windows
      permissions:
        contents: "read"
        id-token: "write"
      env:
        version: ${{ inputs.version }}
        prefix: ${{ inputs.prefix }}
      runs-on: ubuntu-20.04

      steps:
        - uses: actions/download-artifact@v3
          with:
            name: windows${{inputs.build-suffix}}-installer-unsigned

        - uses: actions/setup-python@v4
          with:
            python-version: '3.8'

        - name: Install s3cmd
          run: pip install s3cmd

        - name: Set s3cmd permissions
          run: |
            echo "[default]" > "$HOME/.s3cfg"
            echo "access_key = ${{ secrets.AWS_ACCESS_KEY }}" >> "$HOME/.s3cfg"
            echo "secret_key = ${{ secrets.AWS_SECRET_KEY }}" >> "$HOME/.s3cfg"

        - name: Push binaries to s3
          
          env:
            VERSION: "${{ inputs.version }}"
            dist_versionless: "${{inputs.prefix}}-${{inputs.dist-suffix}}.exe"
            dist: "${{inputs.prefix}}-${{inputs.version}}-${{inputs.dist-suffix}}.exe"
            update: "lantern_update_windows_${{inputs.update-suffix}}-${{inputs.version}}.bz2"

          run: |
            ls -l
            cat lantern.exe | bzip2 > ${{ env.update }}
            mv lantern-installer${{inputs.installer-suffix}}.exe ${{ env.dist }}
            cp ${{ env.dist }} ${{ env.dist_versionless }}

            shasum -a 256 ${{ env.dist }} | cut -d " " -f 1 > ${{ env.dist }}.sha256
            shasum -a 256 ${{ env.update }} | cut -d " " -f 1 > ${{ env.update }}.sha256
            cp ${{ env.dist }}.sha256 ${{ env.dist_versionless }}.sha256
            ls -l

            s3cmd put --acl-public ${{ env.dist }} ${{ env.update }} ${{ env.update }}.sha256 ${{ env.dist }}.sha256 ${{ env.dist_versionless }}.sha256 ${{ env.dist_versionless }} "s3://lantern"

